# Система автоматических подписок SwingFox

## Обзор

Система автоматических подписок SwingFox обеспечивает полную автоматизацию управления подписками пользователей, включая автоматическое продление, смену тарифных планов и мониторинг состояния подписок.

## Архитектура системы

### Основные компоненты

1. **SubscriptionPlans** - Модель тарифных планов
2. **Subscriptions** - Модель подписок пользователей
3. **SubscriptionPayments** - Модель платежей по подпискам
4. **SubscriptionManager** - Сервис автоматического управления
5. **SubscriptionCron** - Cron-задачи для автоматизации

### База данных

#### Таблица `subscription_plans`
- `id` - Уникальный идентификатор
- `name` - Название плана
- `type` - Тип плана (FREE, VIP, PREMIUM)
- `monthly_price` - Цена за месяц в фоксиках
- `quarterly_price` - Цена за квартал в фоксиках
- `yearly_price` - Цена за год в фоксиках
- `features` - JSON с описанием возможностей
- `is_active` - Активен ли план

#### Таблица `subscription_payments`
- `id` - Уникальный идентификатор
- `subscription_id` - ID подписки
- `user_id` - ID пользователя
- `amount` - Сумма в фоксиках
- `payment_method` - Способ оплаты
- `payment_type` - Тип платежа (initial, renewal, upgrade, auto_renewal)
- `status` - Статус платежа
- `transaction_id` - ID транзакции

## Автоматизация

### Cron-задачи

#### Ежедневная задача (00:00)
- Обработка автопродления подписок
- Проверка истекших подписок
- Уведомления о скором истечении
- Проверка подписок с недостатком средств

#### Критическая проверка (каждые 6 часов)
- Проверка подписок с недостатком средств
- Уведомления о скором истечении подписок

### Автопродление

1. **Проверка баланса** - Проверяется достаточность средств для продления
2. **Списание средств** - Автоматическое списание с баланса пользователя
3. **Продление подписки** - Увеличение даты окончания на месяц
4. **Создание платежа** - Запись о совершенном платеже
5. **Уведомление** - Отправка уведомления об успешном продлении

### Обработка недостатка средств

1. **Отключение автопродления** - При недостатке средств автопродление отключается
2. **Сброс статуса** - Статус пользователя сбрасывается на FREE
3. **Уведомление** - Отправка уведомления о необходимости пополнения баланса

## API Endpoints

### Тарифные планы

#### GET `/api/subscription-plans`
Получение всех активных тарифных планов

#### GET `/api/subscription-plans/:type`
Получение конкретного тарифного плана

#### POST `/api/subscription-plans`
Создание нового тарифного плана (только для админов)

#### PUT `/api/subscription-plans/:id`
Обновление тарифного плана (только для админов)

#### DELETE `/api/subscription-plans/:id`
Деактивация тарифного плана (только для админов)

#### GET `/api/subscription-plans/compare/:plan1/:plan2`
Сравнение двух тарифных планов

### Подписки

#### GET `/api/subscriptions/pricing`
Получение тарифов и возможностей

#### POST `/api/subscriptions/create`
Создание новой подписки

#### POST `/api/subscriptions/activate/:id`
Активация подписки

#### POST `/api/subscriptions/cancel/:id`
Отмена подписки

#### POST `/api/subscriptions/change-plan`
Смена тарифного плана

## Тарифные планы

### FREE (Бесплатный)
- **Цена**: 0 фоксиков
- **Возможности**:
  - 1 суперлайк в день
  - Базовые функции

### VIP
- **Цена**: 299/месяц, 799/квартал, 2999/год
- **Возможности**:
  - 5 суперлайков в день
  - 1 внимание в неделю
  - Скрытие статуса онлайн
  - Приватные фото
  - Просмотр лайков
  - Карусель
  - Просмотр посещений
  - Безлимитные лайки

### PREMIUM
- **Цена**: 499/месяц, 1399/квартал, 4999/год
- **Возможности**:
  - Все возможности VIP
  - 10 суперлайков в день
  - 3 внимания в неделю
  - Приоритетная поддержка
  - Эксклюзивные события
  - Кастомные бейджи
  - Буст профиля

## Смена тарифных планов

### Правила смены
1. **Прошлые подписки не учитываются** - При смене плана предыдущие подписки аннулируются
2. **Скидки не применяются** - Новый план оплачивается по полной стоимости
3. **Автопродление** - Включается автоматически для нового плана

### Процесс смены
1. Проверка достаточности средств
2. Отмена текущей активной подписки
3. Списание средств за новый план
4. Создание новой подписки
5. Обновление статуса пользователя
6. Создание записи о платеже
7. Отправка уведомления

## Уведомления

### Типы уведомлений
- `subscription_expired` - Подписка истекла
- `subscription_renewed` - Подписка продлена
- `subscription_expiring_soon` - Подписка скоро истечет
- `low_balance_warning` - Недостаточно средств
- `subscription_upgraded` - Тарифный план изменен

## Безопасность

### Проверки прав
- Создание/редактирование тарифных планов доступно только пользователям с PREMIUM статусом
- Все операции с подписками требуют аутентификации

### Валидация данных
- Проверка корректности типов тарифных планов
- Валидация цен и возможностей
- Проверка существования планов перед созданием

## Мониторинг и логирование

### Логирование
- Все операции логируются через APILogger
- Отдельные логи для каждого компонента системы
- Детальная информация о выполненных операциях

### Мониторинг
- Отслеживание количества обработанных подписок
- Мониторинг ошибок и исключений
- Статистика по типам операций

## Развертывание

### Миграции
1. `20241228000001-create-subscription-plans.js` - Создание таблицы тарифных планов
2. `20241228000002-create-subscription-payments.js` - Создание таблицы платежей

### Сидеры
1. `20241228000001-populate-subscription-plans.js` - Заполнение базовыми тарифными планами

### Зависимости
- `node-cron` - для cron-задач
- `sequelize` - для работы с базой данных

## Тестирование

### Ручное тестирование
1. Создание тестовых подписок
2. Проверка автопродления
3. Тестирование смены тарифных планов
4. Проверка уведомлений

### Автоматическое тестирование
- Unit-тесты для моделей
- Integration-тесты для API
- Тесты cron-задач

## Troubleshooting

### Частые проблемы
1. **Подписка не продлевается** - Проверить баланс пользователя и статус автопродления
2. **Ошибки в cron-задачах** - Проверить логи и права доступа к базе данных
3. **Не работают уведомления** - Проверить модель Notifications и права доступа

### Логи
- Основные логи: `SUBSCRIPTION_MANAGER`
- Cron-задачи: `SUBSCRIPTION_CRON`
- API: `SUBSCRIPTION_PLANS`, `SUBSCRIPTIONS`

## Будущие улучшения

1. **Интеграция с платежными системами** - Поддержка внешних способов оплаты
2. **Аналитика подписок** - Детальная статистика и отчеты
3. **Промокоды и скидки** - Система скидок и промокодов
4. **A/B тестирование** - Тестирование различных тарифных планов
5. **Мобильные push-уведомления** - Уведомления в реальном времени
