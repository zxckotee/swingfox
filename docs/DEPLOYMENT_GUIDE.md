# Руководство по деплойменту системы подписок

## Предварительные требования:
- Node.js 18+
- PostgreSQL 13+
- Redis (для rate limiting)

## Шаги деплоймента:

### 1. Обновление зависимостей
```bash
npm install express-rate-limit joi
```

### 2. Применение миграций
```bash
npx sequelize-cli db:migrate
```

### 3. Заполнение сидеров
```bash
npx sequelize-cli db:seed:all
```

### 4. Перезапуск сервисов
```bash
docker-compose down
docker-compose up --build -d
```

### 5. Проверка работоспособности
```bash
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:3000/api/subscriptions/current
```

## Мониторинг:
- Логи: `docker-compose logs -f backend`
- Метрики: проверять console.log с тегами [METRICS]
- Аудит: проверять console.log с тегами [AUDIT]

## Проверочный список деплоймента:

### Backend:
- [ ] Все зависимости установлены
- [ ] Миграции применены
- [ ] Сидеры заполнены
- [ ] Сервер запущен без ошибок
- [ ] API endpoints отвечают

### Frontend:
- [ ] API методы обновлены
- [ ] Компоненты работают с новой структурой
- [ ] Обработка ошибок настроена

### Безопасность:
- [ ] Rate limiting активен
- [ ] Валидация входных данных работает
- [ ] Аутентификация функционирует

### Мониторинг:
- [ ] Метрики записываются
- [ ] Аудит логи создаются
- [ ] Логи доступны для анализа

## Troubleshooting:

### Ошибка "Cannot find module 'express-rate-limit'"
```bash
npm install express-rate-limit
```

### Ошибка "Cannot find module 'joi'"
```bash
npm install joi
```

### API возвращает 500 ошибки
Проверить логи: `docker-compose logs backend`

### Rate limiting не работает
Проверить, что middleware добавлен в правильном порядке

### Валидация не работает
Проверить, что схемы Joi правильно импортированы

## Rollback план:
Если что-то пошло не так:

1. Остановить новые сервисы
2. Восстановить предыдущую версию из git
3. Перезапустить старые сервисы
4. Проверить работоспособность

## Производительность:
- Rate limiting: 5 запросов за 15 минут
- Валидация: < 1ms на запрос
- Метрики: асинхронная запись в лог

## Безопасность:
- Все входные данные валидируются
- Rate limiting защищает от DDoS
- Аудит логи для отслеживания действий
- Токены аутентификации обязательны
