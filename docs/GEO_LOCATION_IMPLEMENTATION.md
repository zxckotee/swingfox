# Автоматическая геолокация по IP адресу

## Обзор

Система автоматически определяет геолокацию пользователей по их IP адресу при регистрации, используя тот же подход, что и в оригинальном PHP коде.

## Как это работает

### 1. При регистрации пользователя

- Система автоматически получает IP адрес клиента
- Делает запрос к сервису `ip-api.com` для получения координат
- Сохраняет координаты в поле `geo` в формате `lat&&lng`

### 2. Получение IP адреса

Система проверяет различные заголовки для получения реального IP:

1. `X-Forwarded-For` - используется прокси-серверами
2. `X-Real-IP` - используется nginx
3. `req.connection.remoteAddress` - стандартное поле Express
4. `req.ip` - Express 4.x
5. Fallback на `127.0.0.1` для localhost

### 3. Fallback геолокация

Если не удается получить геолокацию по IP, используется fallback координаты:
- **По умолчанию**: Москва (`55.7558&&37.6176`)
- Можно настроить другие координаты в `src/utils/geoLocation.js`

## Файлы реализации

### Основные файлы

- `src/utils/geoLocation.js` - утилиты для геолокации
- `src/routes/auth.js` - интеграция в процесс регистрации
- `scripts/update-user-geo.js` - скрипт обновления существующих пользователей

### Модели

- `src/models/User.js` - поле `geo` для хранения координат
- `src/models/Geo.js` - справочник стран и городов

## API геолокации

### Сервис: ip-api.com

- **URL**: `http://ip-api.com/json/{IP}`
- **Формат ответа**: JSON с полями `lat`, `lon`, `status`
- **Таймаут**: 5 секунд
- **Бесплатный**: до 1000 запросов в день

### Альтернативные сервисы

При необходимости можно заменить на:
- `https://ipapi.co/{IP}/json/`
- `https://api.ipgeolocation.io/ipgeo?apiKey={KEY}&ip={IP}`
- `https://ipinfo.io/{IP}/json`

## Использование

### 1. Автоматическая геолокация при регистрации

```javascript
// В src/routes/auth.js уже интегрировано
// При регистрации автоматически заполняется поле geo
```

### 2. Обновление существующих пользователей

```bash
# Запуск скрипта обновления
node scripts/update-user-geo.js
```

### 3. Ручное получение геолокации

```javascript
const { getGeoWithFallback, getClientIP } = require('../utils/geoLocation');

// Получение IP клиента
const clientIP = getClientIP(req);

// Получение геолокации с fallback
const geo = await getGeoWithFallback(clientIP);
```

## Формат данных

### Поле geo в базе данных

- **Тип**: TEXT
- **Формат**: `lat&&lng` (например: `55.7558&&37.6176`)
- **Примеры**:
  - `55.7558&&37.6176` - Москва
  - `59.9311&&30.3609` - Санкт-Петербург
  - `40.7128&&-74.0060` - Нью-Йорк

### Парсинг координат

```javascript
const { parseGeo } = require('../utils/helpers');

const geoString = "55.7558&&37.6176";
const coordinates = parseGeo(geoString);
// Результат: { lat: 55.7558, lng: 37.6176 }
```

## Безопасность

### Ограничения

- Таймаут запросов: 5 секунд
- Fallback координаты для ошибок
- Логирование всех операций

### Рекомендации

- В продакшене использовать HTTPS для API геолокации
- Добавить rate limiting для API запросов
- Кэшировать результаты геолокации
- Мониторить использование API лимитов

## Мониторинг и логирование

### Логи геолокации

Все операции геолокации логируются через `APILogger`:

```javascript
logger.logProcess('Получение геолокации по IP', { client_ip: clientIP }, req);
logger.logResult('Геолокация по IP', !!geo, { ip: clientIP, geo_coordinates: geo }, req);
```

### Метрики

- Количество успешных геолокаций
- Количество ошибок
- Время ответа API
- Использование fallback координат

## Тестирование

### Локальное тестирование

```bash
# Запуск сервера в режиме разработки
npm run dev:backend

# Тестирование регистрации с геолокацией
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","mail_code":"123456",...}'
```

### Проверка геолокации

```sql
-- Проверка заполнения поля geo
SELECT login, email, geo, country, city 
FROM users 
WHERE geo IS NOT NULL 
LIMIT 10;
```

## Миграция с PHP

### Что перенесено

✅ Функция `setGeo()` → `getGeoByIP()`
✅ Получение IP адреса → `getClientIP()`
✅ Формат координат → `lat&&lng`
✅ Fallback координаты
✅ Интеграция в регистрацию

### Отличия от PHP версии

- Асинхронные запросы вместо синхронных
- Лучшая обработка ошибок
- Валидация IP адресов
- Расширенное логирование
- TypeScript-совместимые типы

## Проблемы и решения

### Частые проблемы

1. **Пустое поле geo у существующих пользователей**
   - Решение: запустить `scripts/update-user-geo.js`

2. **Ошибки API геолокации**
   - Решение: используются fallback координаты

3. **Неправильный IP адрес за прокси**
   - Решение: проверка заголовков `X-Forwarded-For`

### Отладка

```javascript
// Включение подробного логирования
console.log('Client IP:', getClientIP(req));
console.log('Geo result:', await getGeoByIP(clientIP));
```

## Планы развития

### Краткосрочные

- [ ] Кэширование результатов геолокации
- [ ] Rate limiting для API запросов
- [ ] Метрики использования

### Долгосрочные

- [ ] Интеграция с несколькими API геолокации
- [ ] Геолокация по GPS (мобильные приложения)
- [ ] Автоматическое обновление геолокации
- [ ] Геофенсинг и уведомления

## Заключение

Система автоматической геолокации полностью интегрирована в процесс регистрации и работает аналогично оригинальному PHP коду. Все новые пользователи будут автоматически получать координаты по IP адресу, а существующих можно обновить с помощью специального скрипта.
