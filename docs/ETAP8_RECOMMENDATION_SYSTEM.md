# ЭТАП 8: Система рекомендаций на основе совместимости

## Обзор изменений

Вместо жесткой фильтрации, которая исключала пользователей, не соответствующих всем критериям, мы внедрили умную систему рекомендаций. Теперь система показывает всех подходящих пользователей, но сортирует их по вероятности совместимости.

## Ключевые принципы

### 1. Включение вместо исключения
- **Раньше**: Показывали только тех, кто соответствует ВСЕМ критериям
- **Сейчас**: Показываем всех, но сортируем по совместимости

### 2. Вероятностный подход
- Каждый пользователь получает оценку совместимости от 0 до 1
- Сортировка по убыванию совместимости
- Рандомизация топ-30% для разнообразия

### 3. Многофакторная оценка
- Взаимный поиск статусов (25%)
- Возрастная совместимость (20%)
- Географическая близость (15%)
- Предпочтения по местам встреч (15%)
- Образ жизни (10%)
- Физические параметры (10%)
- Активность (5%)

## Техническая реализация

### Backend

#### Новая утилита: `src/utils/compatibilityCalculator.js`
```javascript
class CompatibilityCalculator {
  // Основные методы:
  calculateCompatibility(user1, user2) // Расчет совместимости
  sortByCompatibility(users, currentUser) // Сортировка
  getTopRecommendations(users, currentUser, limit) // Топ рекомендации
}
```

#### Обновленный каталог: `src/routes/catalog.js`
- Убрана жесткая фильтрация по взаимной совместимости
- Добавлен расчет совместимости для каждого пользователя
- Возвращается информация о совместимости в API

#### Обновленный свайп: `src/routes/swipe.js`
- Заменен алгоритм на основе рейтинга на алгоритм совместимости
- Сохранено ограничение только для VIP пользователей
- Добавлена рандомизация топ рекомендаций

### Frontend

#### Обновленная страница каталога: `client/src/pages/Catalog.js`
- Изменен заголовок и описание
- Добавлено отображение процента совместимости
- Визуальный индикатор совместимости (градиентная полоса)

## Алгоритм расчета совместимости

### 1. Взаимный поиск статусов (25%)
```javascript
// Проверяем, что user1 ищет user2 и наоборот
const user1WantsUser2 = checkStatusCompatibility(user1.search_status, user2.status);
const user2WantsUser1 = checkStatusCompatibility(user2.search_status, user1.status);

if (user1WantsUser2 && user2WantsUser1) return 1.0;      // Полная совместимость
else if (user1WantsUser2 || user2WantsUser1) return 0.5; // Частичная совместимость
else return 0.0;                                          // Нет совместимости
```

### 2. Возрастная совместимость (20%)
- Учитываются предпочтения по возрасту из `search_age`
- Бонус за близкий возраст (±5 лет: +20%, ±10 лет: +0%, ±20 лет: -20%)
- Штраф за нарушение возрастных ограничений (-70%)

### 3. Географическая близость (15%)
- 0-50 км: 100%
- 50-100 км: 90%
- 100-200 км: 80%
- 200-500 км: 60%
- 500+ км: 30%

### 4. Предпочтения по местам встреч (15%)
- 0 общих мест: 20%
- 1 общее место: 60%
- 2+ общих места: 100%

### 5. Образ жизни (10%)
- Совпадение по курению: +20%
- Совпадение по алкоголю: +20%
- Оба не курят/не пьют: +10%

### 6. Физические параметры (10%)
- Разница в росте ≤10 см: +20%
- Разница в весе ≤10 кг: +20%

### 7. Активность (5%)
- Оба онлайн: +30%
- Оба активны за день: +10%
- Оба новые пользователи (≤30 дней): +20%

## Преимущества новой системы

### 1. Больше вариантов
- Показываем всех подходящих, а не только идеально подходящих
- Пользователи видят больше потенциальных партнеров

### 2. Лучшее понимание
- Прозрачная оценка совместимости
- Конкретные рекомендации по улучшению профиля

### 3. Гибкость
- Можно настроить веса критериев
- Легко добавить новые факторы совместимости

### 4. Разнообразие
- Рандомизация топ рекомендаций
- Сохранение элемента неожиданности

## Настройка и кастомизация

### Изменение весов
```javascript
// В src/utils/compatibilityCalculator.js
this.weights = {
  mutualStatus: 0.25,  // Можно изменить
  age: 0.20,
  distance: 0.15,
  // ... и т.д.
};
```

### Добавление новых критериев
1. Создать метод расчета (например, `calculateHobbyScore`)
2. Добавить в основной метод `calculateCompatibility`
3. Установить вес в `this.weights`

### Настройка рандомизации
```javascript
// В getTopRecommendations можно изменить процент топ пользователей
const topCount = Math.floor(limit * 0.3); // Сейчас 30%
```

## Обратная совместимость

- Все существующие API endpoints остаются без изменений
- Добавлены новые поля в ответ (compatibility)
- Старые клиенты продолжат работать

## Мониторинг и аналитика

### Логирование
- Все расчеты совместимости логируются
- Отслеживается эффективность алгоритма

### Метрики
- Средний процент совместимости
- Распределение по уровням совместимости
- Время отклика алгоритма

## Планы развития

### Краткосрочные (1-2 недели)
- A/B тестирование разных весов критериев
- Оптимизация производительности алгоритма

### Среднесрочные (1-2 месяца)
- Машинное обучение для улучшения весов
- Персонализация на основе поведения пользователя

### Долгосрочные (3-6 месяцев)
- Интеграция с внешними данными
- Предиктивная аналитика совместимости

## Заключение

Новая система рекомендаций обеспечивает баланс между качеством рекомендаций и разнообразием вариантов. Пользователи получают больше возможностей для знакомств, а система становится более гибкой и настраиваемой.
